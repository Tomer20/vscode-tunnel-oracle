name: Pre-Commit Hooks

on:
  merge_group:
  pull_request:

permissions:
  contents: write

env:
  TERRAFORM_VERSION: 1.12.2

jobs:
  pre-commit:
    name: Pre-Commit Hooks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false
      - run: >-
          git fetch --no-tags --prune --depth=1 origin
          +refs/heads/*:refs/remotes/origin/*

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v3

      - name: Install terraform-docs
        run: |
          curl -Lo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.20.0/terraform-docs-v0.20.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          mv terraform-docs /usr/local/bin/terraform-docs

      - name: Install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Install checkov
        run: pip install checkov

      - name: Run pre-commit hooks
        uses: pre-commit/action@v3.0.1
        env:
          SKIP: no-commit-to-branch
        with:
          extra_args: >-
            --color=always
            --show-diff-on-failure

      # Needed to trigger pre-commit workflow on autofix commit
      - name: Push fixes
        if: failure()
        uses: EndBug/add-and-commit@v9.1.4
        with:
          # Determines the way the action fills missing author name and email.
          # Three options are available:
          # - github_actor -> UserName <UserName@users.noreply.github.com>
          # - user_info -> Your Display Name <your-actual@email.com>
          # - github_actions -> github-actions <email associated with the github logo>
          # Default: github_actor
          default_author: github_actor
          # The message for the commit.
          # Default: 'Commit from GitHub Actions (name of the workflow)'
          message: '[pre-commit] Autofix violations'